<?php

class dingdingModel extends Model { protected $URL_public = 'iv0vd0jd0pj0ii0vd0vv0ap0vp0oma0vv0pj0vj0odd0ooa0omi0vz0odd0jo0ao0vi0am0av0omp0ii0vo0omv0oov0im0vo0omj0oov0im0ao0jd0omp0ij0vo0ooa0oov0ji0am0av0oot0vt0ooi0aj0aj06'; protected $URL_gettoken = 'vb0zb0tp0dt0gbb0ag0za0ggd0vb0ta0zm0zt04'; protected $URL_jsapiticket = 'ud0vd0fj0tf0ff0vd0zzp0zpp0fu0ff0jj0zzp0ff0vz0fp0zzp0fu0vd0zzj0zdf0zdd0jv0vf0vf08'; protected $URL_deptlist = 'fo0jd0iv0ddf0if0ii0ja0ai0fi0ij0iv0ddj0doo0vj0tj0ddt0fj0ii0ji0ai07'; protected $URL_deptcreate = 'ud0iz0fj0zzu0fu0ff0it0tf0uf0fi0fj0zzi0zdd0ji0vi0zdj0uu0zdu0fj0zdt0zdd0iz0fv0vf08'; protected $URL_deptupdate = 'im0vo0jt0ooi0ji0jj0vp0pj0ij0jv0jt0oov0omm0tv0av0pi0ii0vo0jd0omp0omm0vo0ja0aj06'; protected $URL_deptdelete = 'ar0zw0pd0wwa0pa0pp0zm0mp0ap0pz0pd0wwz0wrr0dz0oz0wrz0ar0pz0wbr0wrp0wrr0zw0po0op02'; protected $URL_userlist = 'jvv0ee0he0jve0yy0jvc0ch0jjc0yh0ee0he0ue013'; protected $URL_userget = 'mgg0vv0tv0mgv0jj0mgp0pt0mmg0jg0vv0vm0pv05'; protected $URL_usercreate = 'zdd0ff0if0zdf0uu0zdv0vi0zdj0uu0zdu0fj0zdt0zdd0iz0fv0vf08'; protected $URL_userupdate = 'mgg0vv0tv0mgv0jj0mgp0pt0zj0jj0tm0vo0mgz0mgg0tm0vp0pv05'; protected $URL_userdelete = 'bww0aa0pa0bwa0tt0bwd0dp0bwp0tw0ap0bgw0bwa0bww0pb0ad0da03'; protected $URL_batchdelete = 'taa0kk0ck0tak0hh0taf0fc0taf0kh0kk0kv0tau0hc0ct0kv0tak0hk0ct0ku0ik0ha0kt0fk0fk011'; protected $URL_getuserinfo = 'jvv0ee0he0jve0yy0jvc0ch0jjv0yv0ee0ei0uy0yy0cv0ek0jij0yh0eh0cf0jvy0ye0jjy0ce0ce013'; protected $URL_chatsend = 'message/send_to_conversation'; protected $URL_agentsend = 'tp0pg0ag0oa0tt0pg0pp0do0po0bwd0pp0oa0pa0bgg0bbd0bwt0pm0bgg0ab0db0pt0dw0az0bwz0ta0bgb0dm0oa0at0ap0dp0bwd0at0ap0dz0bbp0at0dw0dp0bbz0pz0db0po0bba0bww0aa0ag0bwa0tt0bwd0dp0bgb0tw0aa0pa0oa03'; protected $URL_attendance = 'tv0tt0tm0dt0vb0ta0zo0gba0tv0ta0zo0gbp0vb0to0za0ggz0va0tt0at0dt0tz0gbv0tp0gbp0vt0zg0ad0gba04'; protected $URL_mediaupload = 'ye0eh0ek0jvh0yh0eh0ky0jje0jvv0ee0kk0jjc0ye0cv0hv0jvh013'; protected $URL_mediaget = 'ye0eh0ek0jvh0yh0eh0ky0jje0yv0cv0ek0ue013'; public $corpid = ''; public $optionpid = '-5'; public $backarr = array(); private $secret = ''; public function initWeixin(){} public function initModel() { $this->backarr = array('errcode'=>-1, 'msg'=>'sorry,error'); $this->option = m('option'); $this->initWeixin(); } public function gettourl($can, $nfa=false) { $url = $this->URL_public; if(substr($url,0,4)!='http'){ $url=$this->rock->jm->uncrypt($url); if($nfa)$url=''; $url.=$this->rock->jm->uncrypt($this->$can); }else{ if($nfa)$url=''; $url.=$this->$can; } return $url; } public function readwxset() { if($this->corpid!='')return $this->corpid; $this->qiyeid = $this->option->getval('dingding_qiyeid'); $this->corpid = $this->option->getval('dingding_corpid'); $this->secret = $this->option->getval('dingding_secret'); if($this->corpid=='' || $this->secret=='')showreturn('','没有设置钉钉',201); return $this->corpid; } public function gettoken($lx=0) { $time = date('Y-m-d H:i:s', time()-2*3600); $rs = $this->option->getone("`num`='dingding_token".$lx."' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $this->readwxset(); $secret = $this->secret; if(isempt($secret))return ''; $url = ''.$this->gettourl('URL_gettoken').'?corpid='.$this->corpid.'&corpsecret='.$secret.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->access_token)){ showreturn('',$result,201); }else{ $val = $arr->access_token; $this->option->setval('dingding_token'.$lx.'@'.$this->optionpid.'', $val); } } } if(isempt($val))showreturn('','无法获取token',201); return $val; } public function getticket() { $time = date('Y-m-d H:i:s', time()-2*3600); $rs = $this->option->getone("`num`='dingding_token1' and `optdt`>'$time'"); $val = ''; if($rs)$val = $rs['value']; if(isempt($val)){ $token = $this->gettoken(); $url = ''.$this->gettourl('URL_jsapiticket').'?access_token='.$token.''; $result = c('curl')->getcurl($url); if($result != ''){ $arr = json_decode($result); if(!isset($arr->ticket)){ showreturn('', $result, 201); }else{ $val = $arr->ticket; $this->option->setval('dingding_token1@'.$this->optionpid.'', $val); } } } if(isempt($val))showreturn('','无法获取token_ticket',201); return $val; } public function setbackarr($code, $msg) { $this->backarr = array('errcode'=>$code, 'msg'=>$msg); return $this->backarr; } public function backerror($msg, $code=-1) { return $this->setbackarr($code, $msg); } public function clearalltoken() { $this->option->update("value=null", "`num` like 'dingding\_%'"); } }